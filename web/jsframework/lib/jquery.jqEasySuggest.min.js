/* jQuery jqEasySuggest plugin
 * Examples and documentation at: http://www.jqeasy.com/
 * Version: 1.0 (24/11/2011)
 * No license. Use it however you want. Just keep this notice included.
 * Requires: jQuery v1.3+
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
(function(a) {
    a.fn.extend({jqEasySuggest: function(b) {
            var c = {ajax_file_path: "", min_keyword_length: 2, showLoadingImage: true, focus_color: "", keyupDelay: 200, id_element: "", sql_match_type: "starts", es_width: "auto", es_opacity: .95, es_max_results: 10, es_offset_left: 0, es_offset_top: 0};
            return this.each(function() {
                function k(b) {
                    var ajax_file_path = c.ajax_file_path;
                    if (typeof (ajax_file_path) == "function")
                        ajax_file_path = ajax_file_path();
                    a.ajax({type: "GET", url: ajax_file_path, dataType: "json", data: {data: b, max_results: c.es_max_results, sql_match_type: c.sql_match_type}, success: function(b) {
                            if (b != 0) {
                                option_list = "<ul id='easy_list_" + f + "' class='easy_list'>";
                                a.each(b, function(a, b) {
                                    if (c.id_element != "" && c.id_element != null) {
                                        option_list += '<li><a href="#" id="' + a + '">' + b + "</a></li>"
                                    } else {
                                        option_list += '<li><a href="#">' + b + "</a></li>"
                                    }
                                });
                                option_list += "</ul>";
                                if (!a("#easy_suggest_" + f).length) {
                                    a("<div id='easy_suggest_" + f + "' class='easy_suggest'></div>").insertAfter(d).css("left", parseInt(d.left) + parseInt(c.es_offset_left)).css("top", parseInt(d.top) + parseInt(d.outerHeight()) + parseInt(c.es_offset_top)).css("opacity", c.es_opacity).html(option_list).css("display", "block");
                                    if (c.es_width == "auto") {
                                        a("#easy_suggest_" + f).css("width", parseInt(d.outerWidth()) - 2)
                                    } else {
                                        a("#easy_suggest_" + f).css("width", parseInt(c.es_width))
                                    }
                                } else {
                                    a("#easy_suggest_" + f).html(option_list).css("display", "block")
                                }
                            } else {
                                a("#easy_suggest_" + f).fadeOut("fast", function() {
                                    a(this).remove()
                                })
                            }
                            a("#easy_suggest_" + f + ' li a').click(function() {
                                d.val(a(this).text());
                            });
                        }, error: function(a, b) {
                            if (a.status === 0) {
                                alert("Not connected.\n Verify Network.")
                            } else if (a.status == 404) {
                                alert("Requested page (" + ajax_file_path + ") could not be found. [404]")
                            } else if (a.status == 500) {
                                alert("Internal Server Error [500]. " + ajax_file_path + " has an error on the page.")
                            } else if (b === "timeout") {
                                alert("Time out error.")
                            } else if (b === "parsererror") {
                                alert("There was a parse error.\n\nPlease verify you have entered a value in 'ajax_file_path' and verify your ajax response is in proper json format.")
                            } else {
                                alert("Uncaught Error.\n\n" + a.responseText)
                            }
                            if (c.showLoadingImage) {
                                d.css("background", "")
                            }
                        }})
                }
                var d = a(this);
                var e;
                var f = Math.floor(Math.random() * 100);
                if (b) {
                    a.extend(c, b)
                }
                var g = d.offset();
                var h = d.css("border-left-width");
                var i = d.css("border-left-style");
                var j = d.css("border-left-color");
                if (c.focus_color != "") {
                    d.focus(function() {
                        d.css("border", h + " " + i + " " + c.focus_color)
                    });
                    d.blur(function() {
                        d.css("border", h + " " + i + " " + j)
                    })
                }
                d.keydown(function(b) {
                    var e = d.val();
                    switch (b.keyCode) {
                        case 40:
                            if (!a("#easy_suggest_" + f).length && a.trim(e).length >= c.min_keyword_length) {
                                k(e)
                            }
                            found = false;
                            a("#easy_list_" + f + " li").each(function() {
                                if (a(this).hasClass("selected"))
                                    found = true
                            });
                            if (found) {
                                var g = a("#easy_list_" + f + " li[class='selected']");
                                if (g.next().text() == "")
                                    a("#easy_list_" + f + " li:first").addClass("selected");
                                else
                                    g.next().addClass("selected");
                                g.removeClass("selected")
                            } else
                                a("#easy_list_" + f + " li:first").addClass("selected");
                            break;
                        case 38:
                            found = false;
                            a("#easy_list_" + f + " li").each(function() {
                                if (a(this).hasClass("selected"))
                                    found = true
                            });
                            if (found) {
                                var g = a("#easy_list_" + f + " li[class='selected']");
                                if (g.prev().text() == "")
                                    a("#easy_list_" + f + " li:last").addClass("selected");
                                else
                                    g.prev().addClass("selected");
                                g.removeClass("selected")
                            } else
                                a("#easy_list_" + f + " li:last").addClass("selected");
                            break;
                        case 13:
                            str = a("#easy_list_" + f + " li[class='selected']").text();
                            if (str.length) {
                                d.val(str);
                                if (c.id_element != "" && c.id_element != null) {
                                    a("#" + c.id_element).val(a("#easy_list_" + f + " li[class='selected'] a").attr("id"))
                                }
                            } else if (e == "") {
                                if (c.id_element != "" && c.id_element != null) {
                                    a("#" + c.id_element).val("")
                                }
                            }
                            a("#easy_suggest_" + f).fadeOut("fast", function() {
                                a(this).remove()
                            });
                            b.preventDefault();
                            break;
                        case 9:
                            str = a("#easy_list_" + f + " li[class='selected']").text();
                            if (str.length) {
                                d.val(str);
                                if (c.id_element != "" && c.id_element != null) {
                                    a("#" + c.id_element).val(a("#easy_list_" + f + " li[class='selected'] a").attr("id"))
                                }
                                b.preventDefault();
                                d.focus()
                            } else if (e == "") {
                                if (c.id_element != "" && c.id_element != null) {
                                    a("#" + c.id_element).val("")
                                }
                            }
                            a("#easy_suggest_" + f).fadeOut("fast", function() {
                                a(this).remove()
                            })
                    }
                }).keyup(function(b) {
                    var g = d.val();
                    if (a.trim(g).length >= c.min_keyword_length) {
                        switch (b.keyCode) {
                            case 40:
                            case 38:
                            case 13:
                            case 9:
                                b.preventDefault();
                                break;
                            case 27:
                                a("#easy_suggest_" + f).fadeOut("fast", function() {
                                    a(this).remove()
                                });
                                break;
                            default:
                                if (c.showLoadingImage) {
                                    d.css("background", "url('images/loading.gif') no-repeat scroll right center transparent")
                                }
                                clearTimeout(e);
                                e = setTimeout(function() {
                                    k(g)
                                }, c.keyupDelay)
                        }
                    } else {
                        a("#easy_suggest_" + f).fadeOut("fast", function() {
                            a(this).remove()
                        })
                    }
                });
                a("#easy_list_" + f + " li").on("mouseover", function() {
                    a("#easy_list_" + f + " li[class='selected']").removeClass("selected");
                    a(this).addClass("selected")
                });
                a("#easy_list_" + f + " li").click(function() {
                    str = a("#easy_list_" + f + " li[class='selected']").text();
                    d.val(str);
                    if (c.id_element != "" && c.id_element != null) {
                        a("#" + c.id_element).val(a("li[class='selected'] a").attr("id"))
                    }
                    a("#easy_suggest_" + f).fadeOut("fast", function() {
                        a(this).remove()
                    });
                    return false
                });
                a(document).click(function() {
                    if (a("#easy_suggest_" + f).css("display") == "block") {
                        a("#easy_suggest_" + f).fadeOut("fast", function() {
                            a(this).remove()
                        })
                    }
                })
            })
        }})
})(jQuery)